<style>
.green {
	color: green;
}

.red {
	color: red;
}

.white {
	color: white;
}

.sticky {
	position: -webkit-sticky;
	position: -moz-sticky;
	position: -ms-sticky;
	position: -o-sticky;
	position: sticky;
	top: 0px;
}
.pick-buttons {
	margin-top: 5px;
	margin-bottom: 5px;
	display: inline-block;
	cursor: pointer;
}

table {
	display: inline !important;/*to override table-responsive so we can keep our sticky table header*/
}
</style>
<div class="container">
	<h3>
		Way <a style="color: inherit" href="https://en.wikipedia.org/wiki/Over-the-top_content" target="_blank">Over the Top</a>
	</h3>
	<div class="row{{pickingMode ? ' sticky' : ''}}" style="background-color: white;">
		<div class="col">
			{{#if pickingMode}}
			<button
			  class="btn btn-outline-primary pick-buttons" 
			  on:click='donePicking()'
			>Done</button>
			{{else}}
			<button
			  class="btn btn-outline-primary pick-buttons" 
			  on:click='set({ channelPickMode: true })'
			>Pick Channels</button>
			<button
			  class="btn btn-outline-primary pick-buttons" 
			  on:click='set({ providerPickMode: true })'
			>Pick Providers</button>
			{{/if}}
		</div>
		<div class="col">
			{{#if pickingMode}}
			<div class="text-right">
		      	<button class="btn btn-outline-primary pick-buttons" on:click="showAll(true)"><span class="hidden-sm-down">Select{{" "}}</span>All</button>
		        <button class="btn btn-outline-primary pick-buttons" on:click="showAll(false)"><span class="hidden-sm-down">Select{{" "}}</span>None</button>
		    </div>
		    {{/if}}
		</div>
	</div>
	{{#if channelPickMode}}
	<ChannelSelector context="Channels" items="{{channels}}" displayProperty="Name" visibleItems="{{visibleChannels}}" bind:shown="shownChannels" />
	{{elseif providerPickMode}}
	<ProviderSelector context="Providers" items="{{providers}}" displayProperty="name" visibleItems="{{visibleProviders}}" bind:shown="shownProviders" />
	{{else}}
	<ChannelList channels="{{visibleChannels}}" providers="{{visibleProviders}}" />
	{{/if}}
</div>

<script>
import channels from './data/provider-channels.js'
import providers from './data/providers.js'
import ChannelList from './ChannelList.html'
import ChannelSelector from './VisibilitySelector.html'
import ProviderSelector from './VisibilitySelector.html'

export default {
	data() {
		var shownChannels = {}
		var shownProviders = {}

		channels.forEach(channel => {
			shownChannels[channel.Name] = true
		})

		function sortArrayByProperty(array, prop) {
			return array.slice().sort((a, b) => {
				const first = a[prop].toUpperCase()
				const next = b[prop].toUpperCase()

				if(first < next) {
					return -1
				}
				else return 1

				return 0
			})
		}

		const sortedChannels = sortArrayByProperty(channels, 'Name')
		const sortedProviders = sortArrayByProperty(providers, 'name')

		providers.forEach(provider => {
			shownProviders[provider.name] = true
		})

		const localStorageShownChannels = localStorage.getItem('shownChannels')
		if(localStorageShownChannels) {
			Object.assign(shownChannels, JSON.parse(localStorageShownChannels))
		}

		const localStorageShownProviders = localStorage.getItem('shownProviders')
		if(localStorageShownProviders) {
			Object.assign(shownProviders, JSON.parse(localStorageShownProviders))
		}
		
		return {
			channels: sortedChannels,
			providers: sortedProviders,
			shownChannels,
			shownProviders
		}
	},
	computed: {
		visibleChannels: (channels, shownChannels) => {
			return channels.filter(channel => shownChannels[channel.Name])
		},
		visibleProviders: (providers, shownProviders) => {
			return providers.filter(provider => shownProviders[provider.name])
		},
		pickingMode: (channelPickMode, providerPickMode) => {
			return channelPickMode || providerPickMode
		}
	},
	components: {
		ChannelList,
		ChannelSelector,
		ProviderSelector
	},
	methods: {
		showAll(show) {
			if(this.get('channelPickMode')) {
				const shown = this.get('shownChannels')
				Object.keys(shown).forEach((channel) => {
				    shown[channel] = show
				});

				this.set({ shownChannels: shown })
				if(show) localStorage.removeItem('shownChannels')
				else localStorage.setItem('shownChannels', JSON.stringify(shown))
			}
			else if(this.get('providerPickMode')) {
				const shown = this.get('shownProviders')
				Object.keys(shown).forEach((provider) => {
				    shown[provider] = show
				});

				this.set({ shownProviders: shown })
				if(show) localStorage.removeItem('shownProviders')
				else localStorage.setItem('shownProviders', JSON.stringify(shown))
			}

		},
		donePicking() {
			this.set({ channelPickMode: false })
			this.set({ providerPickMode: false })
		}
	}
}
</script>
